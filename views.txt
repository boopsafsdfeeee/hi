from django.contrib.admin.views.decorators import staff_member_required




# íŒŒì¼ í•­ëª©ì„ ë‹´ì„ êµ¬ì¡°ì²´
class FileItem:
    def __init__(self, name, is_dir, size=None):
        self.name = name
        self.is_dir = is_dir
        self.size = size

# íŒŒì¼ ê´€ë¦¬ì ë·° (í•µì‹¬ ê¸°ëŠ¥)
@staff_member_required
def file_manager_view(request, client_id, requested_path=''): 
    client = get_object_or_404(Client, client_id=client_id)
    
    # URLì—ì„œ ë°›ì€ ê²½ë¡œ êµ¬ë¶„ì '::'ë¥¼ ì‹¤ì œ ê²½ë¡œ êµ¬ë¶„ì '/'ë¡œ ë³€í™˜
    current_path = requested_path.replace('::', '/')

    if not current_path:
        current_path = "C:\\" 

    # --- 1. ì´ì „ Task ê²°ê³¼ í™•ì¸ ë° íŒŒì‹± ---
    task_id_to_check = request.GET.get('task_id')
    last_task = None
    
    # ë¨¼ì € ìš”ì²­ëœ task_idê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    if task_id_to_check:
        try:
            last_task = CommandTask.objects.get(id=task_id_to_check, client=client)
        except CommandTask.DoesNotExist:
            pass
    
    # task_idê°€ ì—†ê±°ë‚˜ í•´ë‹¹ taskê°€ ì—†ë‹¤ë©´, ê°€ì¥ ìµœê·¼ì˜ EXECUTE_SHELL taskë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    if not last_task:
        last_task = CommandTask.objects.filter(
            client=client,
            command_name='EXECUTE_SHELL'
        ).order_by('-created_at').first()
    
    file_list = []

    if last_task and last_task.status == 'COMPLETED' and last_task.result_content:
        try:
            # ğŸš¨ í˜„ì¬ íŒŒì‹± ë¡œì§ì€ 'dir' ëª…ë ¹ì˜ ìƒì„¸ ì¶œë ¥(Header, Time, <DIR>, Size í¬í•¨)ì„ ì „ì œë¡œ í•©ë‹ˆë‹¤.
            # ğŸš¨ í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ì‹¤ì œ ê²°ê³¼ í¬ë§·ì— ë§ì¶° íŒŒì‹± ë¡œì§ì„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            lines = last_task.result_content.split('\n')
            
            # Add '..' if not at the root
            is_root = (current_path.upper().rstrip('\\/') == "C:")
            if not is_root and current_path != "/":
                file_list.append(FileItem('..', is_dir=True))

            for line in lines:
                line = line.strip()
                if not line or line in ['.', '..']:
                    continue
                
                # ë§¤ìš° ë‹¨ìˆœí™”ëœ íŒŒì‹± ë¡œì§ (ì‹¤ì œ ìƒì„¸ dir ì¶œë ¥ì—ì„œëŠ” ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
                name = os.path.basename(line.rstrip('\\/'))
                is_dir = not os.path.splitext(name)[1] or line.endswith('\\') or line.endswith('/')
                
                file_list.append(FileItem(line, is_dir))

        except Exception as e:
            print(f"[ERROR] Error parsing task result for Task {last_task.id}: {e}")
            pass

    # --- 2. ìƒˆ Task ìƒì„± ìš”ì²­ (ì¤‘ë³µ ë°©ì§€ ë¡œì§ ì ìš©) ---
    path_for_command = current_path.rstrip('\\/') + os.sep
    
    # ğŸŒŸğŸŒŸğŸŒŸ í•µì‹¬ ìˆ˜ì •: í´ë¼ì´ì–¸íŠ¸ê°€ ê¸°ëŒ€í•˜ëŠ” JSON ê°ì²´ í˜•ì‹ìœ¼ë¡œ payload êµ¬ì„± ğŸŒŸğŸŒŸğŸŒŸ
    payload_dict = {
        "command": "dir",
        "arguments": [f"\"{path_for_command}\""], # ê²½ë¡œì— ë”°ì˜´í‘œ í¬í•¨
        "timeout_seconds": 60
    }
    command_payload = json.dumps(payload_dict) # CommandTask.payload í•„ë“œì— ì €ì¥í•  ë¬¸ìì—´
    
    new_task = None
    
    # ì¤‘ë³µ ë°©ì§€ ë¡œì§: PENDING ìƒíƒœì´ë©° ëª…ë ¹ ë‚´ìš©ì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê¸°ì¡´ Task ì¬ì‚¬ìš©
    if last_task and last_task.status == 'PENDING' and last_task.payload == command_payload:
        new_task = last_task
        print(f"[INFO] Reusing pending Task ID {new_task.id} for path {current_path}.")
    else:
        # PENDING ìƒíƒœê°€ ì•„ë‹ˆê±°ë‚˜ ë‹¤ë¥¸ ëª…ë ¹ì´ë¼ë©´ ìƒˆë¡œìš´ Taskë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        new_task = CommandTask.objects.create(
            client=client,
            command_name='EXECUTE_SHELL',
            payload=command_payload, # JSON ë¬¸ìì—´ ì €ì¥
            status='PENDING'
        )
        print(f"[INFO] Created new Task ID {new_task.id} for path {current_path}.")
    
    context = {
        'client': client,
        'current_path': current_path,
        'display_path': current_path.replace('//', '/'), 
        'file_list': file_list,
        'new_task_id': new_task.id if new_task else None,
        'last_task': last_task,
        'title': f'í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ ê´€ë¦¬ì: {client_id}',
        'app_label': 'tasks',
        'command_name': 'EXECUTE_SHELL'
    }

    return render(request, 'tasks/file_manager.html', context)
